services:
  # SwiftBolt ML Backend API
  backend:
    build:
      context: ./ml
      dockerfile: Dockerfile
    container_name: swiftbolt-ml-backend
    ports:
      - "8000:8000"
    environment:
      PYTHONUNBUFFERED: "1"
      PYTHONDONTWRITEBYTECODE: "1"
      SUPABASE_URL: ${SUPABASE_URL}
      # From root .env (SUPABASE_SERVICE_KEY is the service role key)
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_KEY}
      FASTAPI_ENV: ${FASTAPI_ENV:-production}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    env_file:
      - ./ml/.env
    # Uncomment for live code reload (overrides image /app; venv will not be present)
    # volumes:
    #   - ./ml:/app
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    dns:
      - 8.8.8.8
      - 8.8.4.4
    networks:
      - swiftbolt
    # Uncomment to see all output
    # tty: true
    # stdin_open: true

networks:
  swiftbolt:
    driver: bridge
