name: Daily Historical Sync (Polygon)

# Syncs yesterday's verified data from Polygon to ohlc_bars_v2
# This ensures the historical layer is always up-to-date after market close

on:
  schedule:
    # Run at 8:00 PM ET (after market settlement)
    # UTC: 01:00 (EST) or 00:00 (EDT)
    - cron: '0 1 * * 2-6'  # Tue-Sat (covers Mon-Fri trading days)
  workflow_dispatch:
    inputs:
      symbols:
        description: 'Comma-separated symbols (leave empty for all watchlist)'
        required: false
        type: string
      days_back:
        description: 'Days to look back (default: 1 for yesterday)'
        required: false
        default: '1'
        type: string

jobs:
  sync-historical:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd ml
          pip install -r requirements.txt

      - name: Sync historical data
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          MASSIVE_API_KEY: ${{ secrets.MASSIVE_API_KEY }}
        run: |
          cd ml

          SYMBOLS="${{ github.event.inputs.symbols }}"
          DAYS="${{ github.event.inputs.days_back || '1' }}"

          if [ -n "$SYMBOLS" ]; then
            # Specific symbols provided
            IFS=',' read -ra SYMBOL_ARRAY <<< "$SYMBOLS"
            for symbol in "${SYMBOL_ARRAY[@]}"; do
              echo "Syncing $symbol..."
              python src/scripts/deep_backfill_ohlc_v2.py --symbol "$symbol" --force
              sleep 13  # Rate limit (5 req/min for Polygon free tier)
            done
          else
            # All watchlist symbols
            echo "Syncing all watchlist symbols..."
            python src/scripts/deep_backfill_ohlc_v2.py --all --force
          fi

      - name: Cleanup stale intraday data
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # Delete Tradier intraday data older than today
          # This keeps the table clean and prevents confusion
          curl -X DELETE \
            "${SUPABASE_URL}/rest/v1/ohlc_bars_v2?provider=eq.tradier&ts=lt.$(date -u +%Y-%m-%dT00:00:00Z)" \
            -H "apikey: $SUPABASE_KEY" \
            -H "Authorization: Bearer $SUPABASE_KEY" \
            -H "Prefer: return=minimal"

          echo "âœ… Cleaned up stale intraday data"

      - name: Report status
        if: always()
        run: |
          echo "Historical sync completed"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
