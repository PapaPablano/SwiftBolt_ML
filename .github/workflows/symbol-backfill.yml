name: Symbol Backfill Worker

# =============================================================================
# LEGACY WORKFLOW - CRON DISABLED
# =============================================================================
# This workflow's functionality has been consolidated into daily-data-refresh.yml
# The cron schedule is disabled but workflow_dispatch is preserved for manual runs.
# See: .github/workflows/daily-data-refresh.yml
# =============================================================================

on:
  # DISABLED: High-cost polling workflow. Prefer consolidated backfill orchestration.
  # schedule:
  #   - cron: "*/10 13-22 * * 1-5"

  # Manual trigger
  workflow_dispatch:
    inputs:
      symbol:
        description: "Symbol to backfill (optional). Leave blank to process queue."
        required: false
        type: string
      force:
        description: "Force backfill even if data exists"
        required: false
        type: boolean
        default: false

concurrency:
  group: symbol-backfill-${{ github.ref }}
  cancel-in-progress: true

jobs:
  process-backfill-queue:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Check market window (Mon–Fri 13:30–22:00 UTC)
        id: market_window
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
            echo "Manual trigger override"
            exit 0
          fi
          dow=$(date -u +%u)
          hour=$(date -u +%H)
          minute=$(date -u +%M)
          if [ "$dow" -gt 5 ]; then
            echo "run=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ "$hour" -lt 13 ] || [ "$hour" -gt 22 ] || { [ "$hour" -eq 13 ] && [ "$minute" -lt 30 ]; }; then
            echo "run=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "run=true" >> "$GITHUB_OUTPUT"
          echo "Within market window"

      - name: Checkout
        if: steps.market_window.outputs.run == 'true'
        uses: actions/checkout@v4

      - name: Set up Python
        if: steps.market_window.outputs.run == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "ml/requirements.txt"

      - name: Install dependencies
        if: steps.market_window.outputs.run == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r ml/requirements.txt

      # Process queued backfill jobs
      - name: Process Backfill Queue
        if: github.event.inputs.symbol == '' && steps.market_window.outputs.run == 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          MASSIVE_API_KEY: ${{ secrets.MASSIVE_API_KEY }}
        run: |
          cd ml
          python src/scripts/process_backfill_queue.py

      # Manual single-symbol backfill
      - name: Backfill Single Symbol
        if: github.event.inputs.symbol != '' && steps.market_window.outputs.run == 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          MASSIVE_API_KEY: ${{ secrets.MASSIVE_API_KEY }}
        run: |
          cd ml
          FORCE_FLAG=""
          if [ "${{ github.event.inputs.force }}" = "true" ]; then
            FORCE_FLAG="--force"
          fi
          python src/scripts/deep_backfill_ohlc.py --symbol "${{ github.event.inputs.symbol }}" --all-timeframes $FORCE_FLAG

      - name: Job Summary
        if: always()
        run: |
          echo "## Symbol Backfill Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.symbol }}" ]; then
            echo "- **Symbol**: ${{ github.event.inputs.symbol }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Force**: ${{ github.event.inputs.force }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Mode**: Queue processing" >> $GITHUB_STEP_SUMMARY
          fi
