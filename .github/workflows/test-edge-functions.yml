name: Edge Functions Tests

on:
  push:
    branches: [ master, main, develop ]
    paths:
      - 'supabase/functions/**'
      - 'backend/supabase/functions/**'
      - '.github/workflows/test-edge-functions.yml'
  pull_request:
    branches: [ master, main, develop ]
    paths:
      - 'supabase/functions/**'
      - 'backend/supabase/functions/**'

jobs:
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: v1.x
    
    - name: Cache Deno dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.deno
          ~/.cache/deno
        key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}
        restore-keys: |
          ${{ runner.os }}-deno-
    
    - name: Check formatting
      run: |
        deno fmt --check supabase/functions/
    
    - name: Run linter
      run: |
        deno lint supabase/functions/
    
    - name: Type check
      run: |
        # Type check all functions
        for func in supabase/functions/*/index.ts; do
          if [ -f "$func" ]; then
            echo "Type checking: $func"
            deno check "$func"
          fi
        done

  test-functions:
    name: Test Edge Functions
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: v1.x
    
    - name: Cache Deno dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.deno
          ~/.cache/deno
        key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}
        restore-keys: |
          ${{ runner.os }}-deno-
    
    - name: Run tests
      run: |
        # Check if test files exist
        if ls supabase/functions/**/*_test.ts 2>/dev/null; then
          echo "Running Deno tests..."
          deno test --allow-all supabase/functions/
        else
          echo "âš ï¸ No test files found (pattern: *_test.ts)"
          echo "Consider adding tests for your Edge Functions"
        fi
    
    - name: Test coverage (if tests exist)
      continue-on-error: true
      run: |
        if ls supabase/functions/**/*_test.ts 2>/dev/null; then
          deno test --allow-all --coverage=coverage supabase/functions/
          deno coverage coverage --lcov > coverage.lcov
        fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: v1.x
    
    - name: Check for vulnerabilities in dependencies
      run: |
        # Deno has built-in security features
        # Check for outdated dependencies
        echo "Checking for security issues..."
        
        # Run security audit on imports
        for func in supabase/functions/*/index.ts; do
          if [ -f "$func" ]; then
            echo "Scanning: $func"
            # This would ideally use a security scanner
            # For now, just check the code compiles securely
            deno check --remote "$func" || true
          fi
        done

  validate-functions:
    name: Validate Function Structure
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate function structure
      run: |
        echo "Validating Edge Function structure..."
        
        # Check each function has index.ts
        for dir in supabase/functions/*/; do
          func_name=$(basename "$dir")
          
          # Skip special directories
          if [ "$func_name" = "_shared" ]; then
            continue
          fi
          
          if [ ! -f "${dir}index.ts" ]; then
            echo "âŒ Missing index.ts in $func_name"
            exit 1
          fi
          
          echo "âœ… $func_name has index.ts"
        done
        
        echo "All functions have valid structure"
    
    - name: Check for common issues
      run: |
        echo "Checking for common Edge Function issues..."
        
        # Check for hardcoded secrets
        if grep -r "sk-.*" supabase/functions/ --include="*.ts" --exclude-dir="_shared" | grep -v "// "; then
          echo "âš ï¸ Warning: Potential hardcoded secrets detected"
          echo "Make sure to use environment variables for sensitive data"
        fi
        
        # Check for CORS headers
        echo "Checking CORS configuration..."
        for func in supabase/functions/*/index.ts; do
          if [ -f "$func" ]; then
            if ! grep -q "Access-Control-Allow-Origin" "$func" && ! grep -q "corsHeaders" "$func"; then
              func_name=$(basename "$(dirname "$func")")
              echo "âš ï¸ $func_name may be missing CORS headers"
            fi
          fi
        done
        
        echo "Common issues check complete"

  integration-check:
    name: Integration Checks
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, validate-functions]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: v1.x
    
    - name: Check shared dependencies
      run: |
        echo "Validating shared utilities..."
        
        if [ -d "supabase/functions/_shared" ]; then
          echo "Found _shared directory"
          
          # Check each shared module can be imported
          for shared in supabase/functions/_shared/*.ts; do
            if [ -f "$shared" ]; then
              echo "Checking: $shared"
              deno check "$shared" || echo "âš ï¸ Warning: $shared has type errors"
            fi
          done
        else
          echo "No _shared directory found"
        fi
    
    - name: Verify function imports
      run: |
        echo "Checking function imports..."
        
        # Check that functions can import _shared utilities
        for func in supabase/functions/*/index.ts; do
          if [ -f "$func" ]; then
            func_name=$(basename "$(dirname "$func")")
            echo "Checking imports in: $func_name"
            
            # Try to resolve imports (dry run)
            deno check --no-lock "$func" || echo "âš ï¸ $func_name has import issues"
          fi
        done

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, test-functions, security-scan, validate-functions, integration-check]
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "## Edge Functions Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check job statuses
        if [ "${{ needs.lint-and-typecheck.result }}" = "success" ]; then
          echo "âœ… Lint & Type Check: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Lint & Type Check: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.test-functions.result }}" = "success" ]; then
          echo "âœ… Function Tests: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Function Tests: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.security-scan.result }}" = "success" ]; then
          echo "âœ… Security Scan: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Security Scan: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.validate-functions.result }}" = "success" ]; then
          echo "âœ… Structure Validation: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Structure Validation: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.integration-check.result }}" = "success" ]; then
          echo "âœ… Integration Check: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Integration Check: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **Note**: Add \`*_test.ts\` files to enable comprehensive testing" >> $GITHUB_STEP_SUMMARY
