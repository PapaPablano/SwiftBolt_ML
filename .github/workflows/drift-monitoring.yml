name: Model Drift Monitoring

on:
  schedule:
    # Daily at 8 AM UTC (2 AM CST)
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      window_days:
        description: 'Number of days to analyze for drift'
        required: false
        default: '30'

jobs:
  check-drift:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: ml/requirements.txt

      - name: Install dependencies
        run: |
          cd ml
          pip install -r requirements.txt

      - name: Run drift detection
        id: drift
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          cd ml
          python -c "
          import sys
          sys.path.insert(0, '.')
          from src.monitoring.drift_detector import DriftDetector
          from src.monitoring.forecast_staleness import check_all_staleness

          # Check data staleness
          print('ðŸ“Š Checking data staleness...')
          staleness = check_all_staleness()
          any_stale = False
          for name, result in staleness.items():
              print(f'{result.icon} {name}: {result.message}')
              if not result.is_ok:
                  any_stale = True

          if any_stale:
              print('::warning::Some data sources are stale!')

          print('âœ… Drift monitoring complete')
          "

      - name: Check forecast staleness
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          cd ml
          python src/monitoring/forecast_staleness.py --all
        continue-on-error: true

      - name: Alert on critical issues
        if: failure()
        run: |
          echo "::error::Model drift or staleness issues detected!"
          # Add Slack/email notification here if needed
