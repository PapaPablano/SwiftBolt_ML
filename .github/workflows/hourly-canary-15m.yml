name: Hourly Canary (15m->1h)

on:
  # Predict: 15-min cadence (5 min after each quarter-hour bar close). 15:05..22:50 UTC
  # Hourly summary: 10 min after each :30 bar close. 15:40..20:40 UTC => validate :30 bar in ET (infer-target)
  # EOD summary: after regular close. 21:10 UTC
  schedule:
    - cron: "5,20,35,50 15-22 * * 1-5"
    - cron: "40 15-20 * * 1-5"
    - cron: "10 21 * * 1-5"

  workflow_dispatch:
    inputs:
      mode:
        description: "predict = run intraday forecasts; summary = EOD table; hourly_summary = single hour just closed"
        required: true
        type: choice
        options:
          - predict
          - summary
          - hourly_summary
        default: predict
      symbols:
        description: "Comma-separated symbols"
        required: false
        type: string
        default: "AAPL,MSFT,SPY"
      date_et:
        description: "Date in ET for summary (YYYY-MM-DD). Leave empty = today ET."
        required: false
        type: string
      targets_et:
        description: "Comma-separated ET targets (HH:MM). Default matches hourly closes."
        required: false
        type: string
        default: "09:30,10:30,11:30,12:30,13:30,14:30"
      include_missing_realized:
        description: "Include forecast rows with missing realized (debugging); writes missing_realized=true."
        required: false
        type: boolean
        default: false

concurrency:
  group: hourly-canary-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
  ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
  ALPACA_API_SECRET: ${{ secrets.ALPACA_API_SECRET }}

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup ML Environment
        uses: ./.github/actions/setup-ml-env
        with:
          supabase-url: ${{ secrets.SUPABASE_URL }}
          supabase-key: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          database-url: ${{ secrets.DATABASE_URL }}
          alpaca-api-key: ${{ secrets.ALPACA_API_KEY }}
          alpaca-api-secret: ${{ secrets.ALPACA_API_SECRET }}

      - name: Decide mode (schedule vs dispatch)
        id: mode
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "mode=${{ inputs.mode }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          UTC_HOUR=$(date -u +%H | sed 's/^0//')
          UTC_MIN=$(date -u +%M | sed 's/^0//')
          # 21:10 UTC = end-of-day summary
          if [ "$UTC_HOUR" = "21" ] && [ "$UTC_MIN" -ge "5" ] && [ "$UTC_MIN" -le "20" ]; then
            echo "mode=summary" >> $GITHUB_OUTPUT
          # 15:40..20:40 UTC = hourly summary (validate :30 bar in ET via --infer-target-from-now)
          elif [ "$UTC_MIN" = "40" ] && [ "$UTC_HOUR" -ge 15 ] && [ "$UTC_HOUR" -le 20 ]; then
            echo "mode=hourly_summary" >> $GITHUB_OUTPUT
          else
            echo "mode=predict" >> $GITHUB_OUTPUT
          fi

      - name: Ensure realized m15 fresh (pre-predict backfill)
        if: steps.mode.outputs.mode == 'predict'
        env:
          CANARY_SYMBOLS: ${{ github.event_name == 'workflow_dispatch' && inputs.symbols || 'AAPL,MSFT,SPY' }}
        run: |
          cd ml
          python -c "
          import os, subprocess, sys
          from datetime import datetime, timezone
          from src.data.supabase_db import db

          symbols = [s.strip().upper() for s in os.environ.get('CANARY_SYMBOLS','AAPL,MSFT,SPY').split(',') if s.strip()]
          now_utc = datetime.now(timezone.utc)
          stale_minutes = 25
          stale = []

          for sym in symbols:
            r = db.client.table('symbols').select('id').eq('ticker', sym).limit(1).execute()
            if not r.data:
              print(f'  {sym}: no symbol row -> treat stale')
              stale.append(sym)
              continue
            sid = r.data[0]['id']
            q = db.client.table('ohlc_bars_v2').select('ts').eq('symbol_id', sid).eq('timeframe','m15').eq('is_forecast', False).order('ts', desc=True).limit(1).execute()
            ts = q.data[0]['ts'] if q.data else None
            if ts is None:
              print(f'  {sym}/m15: missing -> backfill')
              stale.append(sym)
              continue
            latest = datetime.fromisoformat(ts.replace('Z','+00:00'))
            if latest.tzinfo is None:
              latest = latest.replace(tzinfo=timezone.utc)
            age = (now_utc - latest).total_seconds()/60
            print(f'  {sym}/m15: latest={ts}, age_min={age:.1f}')
            if age > stale_minutes:
              print(f'  {sym}/m15: stale (age {age:.1f} min > {stale_minutes}) -> backfill')
              stale.append(sym)

          if not stale:
            print('All canary symbols have fresh realized m15. No backfill needed.')
            sys.exit(0)

          print('Backfilling stale/missing m15 symbols:', stale)
          try:
            rc = subprocess.run(
              ['python','src/scripts/alpaca_backfill_ohlc_v2.py','--symbols'] + stale + ['--timeframe','m15','--force'],
              timeout=600,
            ).returncode
          except subprocess.TimeoutExpired:
            print('ERROR: Backfill timed out after 10 minutes')
            sys.exit(1)
          sys.exit(rc)
          "

      - name: Recheck m15 after backfill (fail fast if still missing or stale)
        if: steps.mode.outputs.mode == 'predict'
        env:
          CANARY_SYMBOLS: ${{ github.event_name == 'workflow_dispatch' && inputs.symbols || 'AAPL,MSFT,SPY' }}
        run: |
          cd ml
          python -c "
          import os, sys
          from datetime import datetime, timezone
          from src.data.supabase_db import db

          symbols = [s.strip().upper() for s in os.environ.get('CANARY_SYMBOLS','AAPL,MSFT,SPY').split(',') if s.strip()]
          now_utc = datetime.now(timezone.utc)
          stale_minutes = 25
          bad = []

          for sym in symbols:
            r = db.client.table('symbols').select('id').eq('ticker', sym).limit(1).execute()
            if not r.data:
              bad.append((sym, 'no symbol row'))
              continue
            sid = r.data[0]['id']
            q = db.client.table('ohlc_bars_v2').select('ts').eq('symbol_id', sid).eq('timeframe','m15').eq('is_forecast', False).order('ts', desc=True).limit(1).execute()
            if not q.data:
              bad.append((sym, 'missing m15'))
              continue
            ts = q.data[0]['ts']
            latest = datetime.fromisoformat(ts.replace('Z','+00:00'))
            if latest.tzinfo is None:
              latest = latest.replace(tzinfo=timezone.utc)
            age = (now_utc - latest).total_seconds()/60
            if age > stale_minutes:
              bad.append((sym, f'stale (age {age:.1f} min > {stale_minutes})'))

          if bad:
            print('ERROR: After backfill, cannot proceed:')
            for sym, reason in bad:
              print(f'  {sym}: {reason}')
            sys.exit(1)
          print('All canary symbols have fresh m15 data. Proceeding to predict.')
          "

      - name: Hourly predict (15m horizon, canary symbols)
        if: steps.mode.outputs.mode == 'predict'
        run: |
          cd ml
          SYMS="${{ github.event_name == 'workflow_dispatch' && inputs.symbols || 'AAPL,MSFT,SPY' }}"
          IFS=',' read -ra ARR <<< "$SYMS"
          for s in "${ARR[@]}"; do
            sym="$(echo "$s" | xargs | tr '[:lower:]' '[:upper:]')"
            if [ -z "$sym" ]; then
              continue
            fi
            echo "Running intraday forecast for $sym (horizon=15m)"
            python -m src.intraday_forecast_job --symbol "$sym" --horizon "15m"
          done

      - name: Print latest ohlc_bars_v2 timestamps (realized m15)
        if: steps.mode.outputs.mode == 'summary' || steps.mode.outputs.mode == 'hourly_summary'
        env:
          CANARY_SYMBOLS: ${{ github.event_name == 'workflow_dispatch' && inputs.symbols || 'AAPL,MSFT,SPY' }}
        run: |
          cd ml
          python -c "
          import os
          from src.data.supabase_db import db
          symbols = [s.strip().upper() for s in os.environ.get('CANARY_SYMBOLS', 'AAPL,MSFT,SPY').split(',') if s.strip()]
          for sym in symbols:
            r = db.client.table('symbols').select('id').eq('ticker', sym).limit(1).execute()
            if not r.data:
              print('  ', sym, ': no symbol row')
              continue
            sid = r.data[0]['id']
            q = db.client.table('ohlc_bars_v2').select('ts').eq('symbol_id', sid).eq('timeframe', 'm15').eq('is_forecast', False).order('ts', desc=True).limit(1).execute()
            ts = q.data[0]['ts'] if q.data else None
            print('  ', sym, '/m15 realized: latest_ts=', ts)
          "

      - name: Hourly summary (single target just closed)
        if: steps.mode.outputs.mode == 'hourly_summary'
        run: |
          cd ml
          mkdir -p validation_results
          SYMBOLS="${{ github.event_name == 'workflow_dispatch' && inputs.symbols || 'AAPL,MSFT,SPY' }}"
          # Scheduled runs: default to --include-missing-realized until ingestion is stable. Dispatch: respect input.
          MISSING_FLAG="${{ (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.include_missing_realized == 'true')) && '--include-missing-realized' || '' }}"
          echo "Validating single target (ET, inferred from current UTC)"
          python scripts/hourly_canary_summary.py \
            --symbols "$SYMBOLS" \
            --infer-target-from-now \
            --forecast-source intraday \
            $MISSING_FLAG \
            --out "validation_results/hourly_canary_summary.csv"

      - name: End-of-day summary (predicted vs realized)
        if: steps.mode.outputs.mode == 'summary'
        run: |
          cd ml
          mkdir -p validation_results
          SYMBOLS="${{ github.event_name == 'workflow_dispatch' && inputs.symbols || 'AAPL,MSFT,SPY' }}"
          DATE_ET="${{ github.event_name == 'workflow_dispatch' && inputs.date_et || '' }}"
          TARGETS_ET="${{ github.event_name == 'workflow_dispatch' && inputs.targets_et || '09:30,10:30,11:30,12:30,13:30,14:30' }}"
          # Scheduled: default to --include-missing-realized until ingestion stable. Dispatch: respect input.
          MISSING_FLAG="${{ (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.include_missing_realized == 'true')) && '--include-missing-realized' || '' }}"

          python scripts/hourly_canary_summary.py \
            --symbols "$SYMBOLS" \
            --date-et "$DATE_ET" \
            --targets-et "$TARGETS_ET" \
            --forecast-source intraday \
            $MISSING_FLAG \
            --out "validation_results/hourly_canary_summary.csv"

      - name: Upload summary artifact
        if: steps.mode.outputs.mode == 'summary' || steps.mode.outputs.mode == 'hourly_summary'
        uses: actions/upload-artifact@v4
        with:
          name: hourly-canary-summary
          path: ml/validation_results/hourly_canary_summary.csv
