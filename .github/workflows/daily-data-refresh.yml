name: Daily Data Refresh

# =============================================================================
# CONSOLIDATED DATA INGESTION WORKFLOW
# =============================================================================
# This is the canonical workflow for all OHLC data ingestion.
# It replaces the following legacy workflows:
#   - backfill-ohlc.yml (now workflow_dispatch only)
#   - batch-backfill-cron.yml (cron disabled)
#   - daily-historical-sync.yml (cron disabled, yfinance deprecated)
#
# Usage:
#   - Scheduled: Runs daily incremental refresh
#   - Manual: Use workflow_dispatch inputs for targeted operations
# =============================================================================

on:
  schedule:
    # Run at 6:00 AM UTC (12:00 AM CST) every day
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      full_backfill:
        description: 'Run full backfill with gap detection (slower, more thorough)'
        required: false
        type: boolean
        default: false
      symbol:
        description: 'Single symbol to process (leave empty for all watchlist)'
        required: false
        type: string
      timeframe:
        description: 'Single timeframe to process (leave empty for all: m15,h1,h4,d1,w1)'
        required: false
        type: choice
        options:
          - ''
          - m15
          - h1
          - h4
          - d1
          - w1

concurrency:
  group: daily-data-refresh-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
  ALPACA_API_SECRET: ${{ secrets.ALPACA_API_SECRET }}

jobs:
  # ===========================================================================
  # INCREMENTAL REFRESH (Default: runs daily on schedule)
  # ===========================================================================
  incremental-refresh:
    if: ${{ !inputs.full_backfill }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        timeframe: ${{ inputs.timeframe != '' && fromJSON(format('["{0}"]', inputs.timeframe)) || fromJSON('["m15", "h1", "h4", "d1", "w1"]') }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup ML Environment
        uses: ./.github/actions/setup-ml-env
        with:
          supabase-url: ${{ secrets.SUPABASE_URL }}
          supabase-key: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          database-url: ${{ secrets.DATABASE_URL }}
          alpaca-api-key: ${{ secrets.ALPACA_API_KEY }}
          alpaca-api-secret: ${{ secrets.ALPACA_API_SECRET }}
      
      - name: Refresh ${{ matrix.timeframe }} data
        run: |
          cd ml
          echo "ðŸ“Š Refreshing ${{ matrix.timeframe }} timeframe..."
          echo "â„¹ï¸ Note: OHLC validation should be performed by alpaca_backfill_ohlc_v2.py before insertion"
          echo "   If validation fails, data will not be inserted (see script implementation)"
          
          SYMBOL_FLAG=""
          if [ -n "${{ inputs.symbol }}" ]; then
            SYMBOL_FLAG="--symbols ${{ inputs.symbol }}"
          else
            SYMBOL_FLAG="--all"
          fi
          
          python src/scripts/alpaca_backfill_ohlc_v2.py $SYMBOL_FLAG --timeframe ${{ matrix.timeframe }}
      
      - name: Job summary
        if: always()
        run: |
          echo "## Incremental Refresh: ${{ matrix.timeframe }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Symbol**: ${{ inputs.symbol || 'All watchlist' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timeframe**: ${{ matrix.timeframe }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # FULL BACKFILL (Manual trigger with full_backfill=true)
  # ===========================================================================
  full-backfill:
    if: ${{ inputs.full_backfill == true }}
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup ML Environment
        uses: ./.github/actions/setup-ml-env
        with:
          supabase-url: ${{ secrets.SUPABASE_URL }}
          supabase-key: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          database-url: ${{ secrets.DATABASE_URL }}
          alpaca-api-key: ${{ secrets.ALPACA_API_KEY }}
          alpaca-api-secret: ${{ secrets.ALPACA_API_SECRET }}
      
      - name: Run full backfill with gap detection
        run: |
          cd ml
          echo "ðŸ”„ Running full backfill with gap detection..."
          
          if [ -n "${{ inputs.symbol }}" ]; then
            # Single symbol backfill
            for tf in m15 h1 h4 d1 w1; do
              echo "ðŸ“Š Backfilling ${{ inputs.symbol }} - $tf"
              python src/scripts/alpaca_backfill_ohlc_v2.py --symbols ${{ inputs.symbol }} --timeframe $tf --force || echo "âš ï¸ $tf failed"
            done
          else
            # Full backfill all symbols
            chmod +x src/scripts/smart_backfill_all.sh
            ./src/scripts/smart_backfill_all.sh
          fi

  # ===========================================================================
  # VALIDATION (Runs after both incremental and full backfill)
  # ===========================================================================
  validate-data:
    needs: [incremental-refresh, full-backfill]
    if: always() && (needs.incremental-refresh.result == 'success' || needs.full-backfill.result == 'success')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup ML Environment
        uses: ./.github/actions/setup-ml-env
        with:
          supabase-url: ${{ secrets.SUPABASE_URL }}
          supabase-key: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          database-url: ${{ secrets.DATABASE_URL }}
          alpaca-api-key: ${{ secrets.ALPACA_API_KEY }}
          alpaca-api-secret: ${{ secrets.ALPACA_API_SECRET }}
      
      - name: Validate data quality and OHLC integrity
        run: |
          cd ml
          echo "ðŸ” Validating data quality and OHLC integrity..."
          
          # Run gap detection
          python src/scripts/backfill_with_gap_detection.py --all > /tmp/validation_report.txt || true
          cat /tmp/validation_report.txt
          
          # Also validate OHLC consistency
          echo ""
          echo "ðŸ” Validating OHLC consistency..."
          python -c "
          import os
          from dotenv import load_dotenv
          load_dotenv()
          
          from src.data.data_validator import OHLCValidator
          from src.data.supabase_db import db
          
          validator = OHLCValidator()
          test_symbols = ['SPY', 'AAPL', 'NVDA', 'MSFT']
          
          ohlc_errors = []
          for symbol in test_symbols:
              for tf in ['d1', 'h4']:
                  try:
                      df = db.fetch_ohlc_bars(symbol, timeframe=tf, limit=100)
                      if df.empty:
                          continue
                      df, result = validator.validate(df, fix_issues=False)
                      if not result.is_valid:
                          ohlc_errors.append(f'{symbol}/{tf}: {result.issues}')
                          print(f'âŒ {symbol}/{tf}: {result.issues}')
                      else:
                          print(f'âœ… {symbol}/{tf}: OHLC valid')
                  except Exception as e:
                      print(f'âš ï¸ {symbol}/{tf}: Error - {e}')
          
          if ohlc_errors:
              print('')
              print('âš ï¸ OHLC validation issues detected:')
              for error in ohlc_errors:
                  print(f'  - {error}')
              print('::warning::OHLC data quality issues detected')
          else:
              print('')
              print('âœ… OHLC consistency validated')
          " || echo "âš ï¸ OHLC validation check completed with warnings"
      
      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-report-${{ github.run_number }}
          path: /tmp/validation_report.txt
          retention-days: 7
      
      - name: Check for critical gaps
        continue-on-error: true
        run: |
          cd ml
          python src/scripts/backfill_with_gap_detection.py --all
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Data refresh failed or gaps detected!"
          echo "Check the validation report artifact for details."
          echo "Manual intervention may be required."
      
      - name: Final summary
        if: always()
        run: |
          echo "## Daily Data Refresh Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: ${{ inputs.full_backfill && 'Full Backfill' || 'Incremental' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Symbol**: ${{ inputs.symbol || 'All watchlist' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timeframe**: ${{ inputs.timeframe || 'All (m15, h1, h4, d1, w1)' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Data Tables Updated" >> $GITHUB_STEP_SUMMARY
          echo "- \`ohlc_bars_v2\` - Multi-timeframe OHLC data" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Workflows" >> $GITHUB_STEP_SUMMARY
          echo "- ML Orchestration will trigger automatically on success" >> $GITHUB_STEP_SUMMARY
          echo "- Check \`intraday-ingestion.yml\` for real-time updates during market hours" >> $GITHUB_STEP_SUMMARY
