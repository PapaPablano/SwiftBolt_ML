name: CI - Lightweight (Code Quality)

# Trigger on pushes and PRs to main branches
on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

# Cancel in-progress runs for same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # CHANGE DETECTION - Determine what needs testing
  # ===========================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      ml: ${{ steps.filter.outputs.ml }}
      edge_functions: ${{ steps.filter.outputs.edge_functions }}
      migrations: ${{ steps.filter.outputs.migrations }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check changed files
      uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          ml:
            - 'ml/**'
            - 'requirements*.txt'
          edge_functions:
            - 'supabase/functions/**'
            - 'backend/supabase/functions/**'
          migrations:
            - 'supabase/migrations/**'
            - 'supabase/seed.sql'

  # ===========================================================================
  # ML CODE QUALITY (Linting only - no heavy dependencies)
  # ===========================================================================
  lint-ml:
    name: ML Linting & Type Checks
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.ml == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Cache linting tools
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-lint-${{ hashFiles('.github/workflows/ci-lightweight.yml') }}
        restore-keys: |
          ${{ runner.os }}-pip-lint-

    - name: Install linting tools (lightweight only)
      run: |
        cd ml
        python -m pip install --upgrade pip
        # Only install linting tools - NOT the full ML stack
        pip install black mypy flake8 isort bandit safety

    - name: Check formatting (Black)
      run: |
        cd ml
        black --check src tests || (
          echo "‚ùå Code formatting issues detected"
          echo "Run: black src tests"
          exit 1
        )

    - name: Check import sorting (isort)
      run: |
        cd ml
        isort --check-only src tests || (
          echo "‚ùå Import sorting issues detected"
          echo "Run: isort src tests"
          exit 1
        )

    - name: Lint (flake8)
      run: |
        cd ml
        flake8 src tests \
          --max-line-length=120 \
          --extend-ignore=E203,W503 \
          --statistics

    - name: Type check (mypy)
      continue-on-error: true
      run: |
        cd ml
        mypy src --ignore-missing-imports --pretty

    - name: Security check (Bandit)
      continue-on-error: true
      run: |
        cd ml
        bandit -r src -f json -o bandit-report.json
        bandit -r src -f screen

    - name: Dependency vulnerabilities (Safety)
      continue-on-error: true
      run: |
        cd ml
        safety check --json || echo "‚ö†Ô∏è Some vulnerabilities detected"

  # ===========================================================================
  # EDGE FUNCTIONS TESTS
  # ===========================================================================
  test-edge-functions:
    name: Edge Functions Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.edge_functions == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: v1.x

    - name: Cache Deno dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.deno
          ~/.cache/deno
        key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}
        restore-keys: |
          ${{ runner.os }}-deno-

    - name: Format check
      run: deno fmt --check supabase/functions/

    - name: Lint
      run: deno lint supabase/functions/

    - name: Type check
      run: |
        for func in supabase/functions/*/index.ts; do
          if [ -f "$func" ]; then
            echo "Type checking: $func"
            deno check "$func"
          fi
        done

    - name: Run tests
      continue-on-error: true
      run: |
        if ls supabase/functions/**/*_test.ts 2>/dev/null; then
          deno test --allow-all supabase/functions/
        else
          echo "‚ö†Ô∏è No tests found - consider adding *_test.ts files"
        fi

    - name: Validate structure
      run: |
        for dir in supabase/functions/*/; do
          func_name=$(basename "$dir")
          if [ "$func_name" = "_shared" ]; then continue; fi

          if [ ! -f "${dir}index.ts" ]; then
            echo "‚ùå Missing index.ts in $func_name"
            exit 1
          fi
        done
        echo "‚úÖ All functions have valid structure"

  # ===========================================================================
  # DATABASE MIGRATION VALIDATION
  # ===========================================================================
  validate-migrations:
    name: Validate DB Migrations
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.migrations == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest

    - name: Validate migration files
      run: |
        echo "Validating migration file structure..."

        # Check migration naming convention
        for file in supabase/migrations/*.sql; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")

            # Check format: YYYYMMDDHHMMSS_description.sql
            if ! echo "$filename" | grep -qE '^[0-9]{14}_.*\.sql$'; then
              echo "‚ùå Invalid migration name: $filename"
              echo "Expected format: YYYYMMDDHHMMSS_description.sql"
              exit 1
            fi

            echo "‚úÖ $filename"
          fi
        done

    - name: Check for SQL syntax errors
      run: |
        echo "Checking SQL syntax..."

        for file in supabase/migrations/*.sql; do
          if [ -f "$file" ]; then
            # Basic syntax validation (checks for common errors)
            if grep -qE "(CREAT TABLE|ALTE TABLE|DELTE FROM)" "$file"; then
              echo "‚ö†Ô∏è Possible typo in $file"
            fi
          fi
        done

    - name: Start local Supabase
      run: supabase start

    - name: Run migrations on local instance
      run: |
        supabase db reset --db-url postgresql://postgres:postgres@127.0.0.1:54322/postgres
        echo "‚úÖ Migrations applied successfully to local instance"

    - name: Stop local Supabase
      if: always()
      run: supabase stop

  # ===========================================================================
  # COMPREHENSIVE REPORT
  # ===========================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, lint-ml, test-edge-functions, validate-migrations]
    if: always()

    steps:
    - name: Generate summary
      run: |
        echo "# üöÄ CI Test Results (Lightweight)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Actor**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "## üìä Code Quality Checks" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Changed components
        echo "### Changed Components" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.detect-changes.outputs.ml }}" = "true" ]; then
          echo "- üêç ML Code (linting only)" >> $GITHUB_STEP_SUMMARY
        fi
        if [ "${{ needs.detect-changes.outputs.edge_functions }}" = "true" ]; then
          echo "- ‚ö° Edge Functions" >> $GITHUB_STEP_SUMMARY
        fi
        if [ "${{ needs.detect-changes.outputs.migrations }}" = "true" ]; then
          echo "- üóÑÔ∏è Database Migrations" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

        # Job results
        echo "### Job Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # ML Linting
        if [ "${{ needs.detect-changes.outputs.ml }}" = "true" ]; then
          if [ "${{ needs.lint-ml.result }}" = "success" ]; then
            echo "‚úÖ ML Linting: **PASSED**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.lint-ml.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è ML Linting: SKIPPED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå ML Linting: **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi
        fi

        # Edge Functions
        if [ "${{ needs.detect-changes.outputs.edge_functions }}" = "true" ]; then
          if [ "${{ needs.test-edge-functions.result }}" = "success" ]; then
            echo "‚úÖ Edge Functions: **PASSED**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-edge-functions.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è Edge Functions: SKIPPED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Edge Functions: **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi
        fi

        # Migrations
        if [ "${{ needs.detect-changes.outputs.migrations }}" = "true" ]; then
          if [ "${{ needs.validate-migrations.result }}" = "success" ]; then
            echo "‚úÖ Migration Validation: **PASSED**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.validate-migrations.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è Migration Validation: SKIPPED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Migration Validation: **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ‚ÑπÔ∏è Full ML Testing" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Comprehensive ML tests (unit tests, coverage, performance) run separately in **ml-validation.yml**:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **On Schedule**: Weekly (Mondays 2:00 UTC)" >> $GITHUB_STEP_SUMMARY
        echo "- **On-Demand**: Via workflow dispatch" >> $GITHUB_STEP_SUMMARY
        echo "- **On Requirement Change**: When requirements.txt is modified (2 Python versions)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "_Generated by GitHub Actions_" >> $GITHUB_STEP_SUMMARY

    - name: Check overall status
      run: |
        # Fail if any required job failed
        if [ "${{ needs.lint-ml.result }}" = "failure" ] || \
           [ "${{ needs.test-edge-functions.result }}" = "failure" ] || \
           [ "${{ needs.validate-migrations.result }}" = "failure" ]; then
          echo "‚ùå One or more CI jobs failed"
          exit 1
        fi

        echo "‚úÖ All CI checks passed!"
