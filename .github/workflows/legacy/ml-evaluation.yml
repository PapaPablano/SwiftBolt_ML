name: ML Forecast Evaluation (Feedback Loop)

# =============================================================================
# LEGACY WORKFLOW - CRON DISABLED
# =============================================================================
# This workflow's functionality has been consolidated into ml-orchestration.yml
# The cron schedule is disabled but workflow_dispatch is preserved for manual runs.
# See: .github/workflows/ml-orchestration.yml
# =============================================================================

on:
  # DISABLED: Consolidated into ml-orchestration.yml
  # schedule:
  #   - cron: "0 6 * * 1-5"  # Weekdays only (Mon-Fri)

  # Manual trigger (GitHub UI -> Actions -> Run workflow)
  workflow_dispatch:
    inputs:
      horizon:
        description: "Horizon to evaluate (1D, 1W, 1M, or 'all')"
        required: false
        type: string
        default: "all"
      update_weights:
        description: "Update model weights based on performance"
        required: false
        type: boolean
        default: true

jobs:
  ml-evaluation:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "ml/requirements.txt"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ml/requirements.txt

      # Scheduled run: evaluate all horizons
      - name: ML Evaluation (scheduled)
        if: github.event_name == 'schedule'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          cd ml
          python -m src.evaluation_job

      # Manual run: optional horizon filter
      - name: ML Evaluation (manual)
        if: github.event_name == 'workflow_dispatch'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          cd ml

          HORIZON="${{ github.event.inputs.horizon }}"

          if [ "$HORIZON" = "all" ] || [ -z "$HORIZON" ]; then
            # Evaluate all horizons
            python -m src.evaluation_job
          else
            # Specific horizon
            python -c "
          from src.evaluation_job import run_evaluation_job
          import json
          results = run_evaluation_job(horizons=['$HORIZON'])
          print(json.dumps(results, indent=2, default=str))
          "
          fi

      # Trigger weight update via Supabase RPC
      - name: Update Model Weights
        if: github.event.inputs.update_weights == 'true' || github.event_name == 'schedule'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # Call the Supabase RPC function to update weights
          curl -s -X POST \
            "${SUPABASE_URL}/rest/v1/rpc/trigger_weight_update" \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Content-Type: application/json" \
            -d '{}' | jq .

      - name: Get Accuracy Summary
        if: always()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # Fetch accuracy summary for job output
          curl -s "${SUPABASE_URL}/functions/v1/ml-dashboard?action=accuracy" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" | jq .

      - name: Job summary
        if: always()
        run: |
          echo "## ML Forecast Evaluation (Feedback Loop)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "- **Schedule**: Weekdays at 06:00 UTC (after market data is finalized)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "- **Horizon**: ${{ github.event.inputs.horizon || 'all' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Update Weights**: ${{ github.event.inputs.update_weights }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What This Job Does" >> $GITHUB_STEP_SUMMARY
          echo "1. **Evaluates past forecasts** - Compares predictions to actual market outcomes" >> $GITHUB_STEP_SUMMARY
          echo "2. **Records accuracy metrics** - Stores results in \`forecast_evaluations\` table" >> $GITHUB_STEP_SUMMARY
          echo "3. **Updates performance history** - Tracks daily accuracy trends" >> $GITHUB_STEP_SUMMARY
          echo "4. **Adjusts model weights** - Increases weight of better-performing model (RF vs GB)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Feedback Loop Architecture" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "Market Data → Features → Train Model → Forecast → Store" >> $GITHUB_STEP_SUMMARY
          echo "     ↑                                          ↓" >> $GITHUB_STEP_SUMMARY
          echo "     └── Retrain ← Evaluate ← Compare to Actual Prices" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Data Updated" >> $GITHUB_STEP_SUMMARY
          echo "- \`forecast_evaluations\` - Individual forecast accuracy records" >> $GITHUB_STEP_SUMMARY
          echo "- \`model_performance_history\` - Daily accuracy summaries" >> $GITHUB_STEP_SUMMARY
          echo "- \`model_weights\` - Ensemble weights (RF vs GB)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- View accuracy dashboard: \`/functions/v1/ml-dashboard?action=full_report\`" >> $GITHUB_STEP_SUMMARY
          echo "- Check model weights: \`/functions/v1/ml-dashboard?action=weights\`" >> $GITHUB_STEP_SUMMARY
          echo "- View daily trends: \`/functions/v1/ml-dashboard?action=trend\`" >> $GITHUB_STEP_SUMMARY
